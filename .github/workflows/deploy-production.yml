name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag to deploy (e.g., v1.0.0)'
        required: true
        type: string
      deployment_type:
        description: 'Deployment strategy'
        required: true
        type: choice
        options:
          - 'blue-green'
          - 'canary'
          - 'rolling'
        default: 'blue-green'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  PROD_HOST: opssight.io

jobs:
  # Manual approval gate
  approval:
    name: Production Deployment Approval
    runs-on: ubuntu-latest
    environment:
      name: production-approval
    steps:
      - name: Request approval
        run: |
          echo "üöÄ Production deployment requested for version ${{ inputs.version }}"
          echo "‚è≥ Waiting for manual approval..."

  # Database backup
  database-backup:
    name: Backup Production Database
    runs-on: ubuntu-latest
    needs: approval
    environment: production
    steps:
      - name: Create database backup
        run: |
          BACKUP_NAME="prod-backup-$(date +%Y%m%d-%H%M%S)-pre-${{ inputs.version }}.sql"
          echo "Creating backup: ${BACKUP_NAME}"

  # Production deployment
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [approval, database-backup]
    environment:
      name: production
      url: https://${{ env.PROD_HOST }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Deploy to production
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          script: |
            cd /opt/opssight
            export VERSION=${{ inputs.version }}
            docker-compose -f docker-compose.prod.yml pull
            docker-compose -f docker-compose.prod.yml up -d
            docker system prune -f

  # Post-deployment validation
  post-deploy-validation:
    name: Validate Production Deployment
    runs-on: ubuntu-latest
    needs: deploy-production
    steps:
      - name: Run health checks
        run: |
          sleep 60
          curl -f https://${{ env.PROD_HOST }}/api/health || exit 1
          curl -f https://${{ env.PROD_HOST }}/api/v1/health || exit 1

      - name: Notify success
        if: success()
        run: echo "Production deployment successful!"