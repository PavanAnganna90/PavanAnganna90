name: Deploy to Staging

on:
  push:
    branches: [ develop ]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to deploy (leave empty for latest)'
        required: false
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  STAGING_HOST: staging.opssight.io
  STAGING_NAMESPACE: opssight-staging

jobs:
  # Pre-deployment checks
  pre-deploy:
    name: Pre-deployment Validation
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Determine version
        id: version
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_SHA::8}" >> $GITHUB_OUTPUT
          fi

  # Database Migration
  database-migration:
    name: Run Database Migrations
    runs-on: ubuntu-latest
    needs: pre-deploy
    environment: staging
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Run migration in Docker
        env:
          DATABASE_URL: ${{ secrets.STAGING_DATABASE_URL }}
        run: |
          docker run --rm \
            -e DATABASE_URL="${DATABASE_URL}" \
            -v $(pwd)/backend:/app \
            python:3.11-slim \
            bash -c "cd /app && pip install -r requirements.txt && alembic upgrade head"

  # Deploy to Staging
  deploy-staging:
    name: Deploy to Staging Environment
    runs-on: ubuntu-latest
    needs: [pre-deploy, database-migration]
    environment: 
      name: staging
      url: https://${{ env.STAGING_HOST }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Deploy to staging server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          script: |
            cd /opt/opssight
            git pull origin develop
            docker-compose -f docker-compose.prod.yml pull
            docker-compose -f docker-compose.prod.yml up -d --force-recreate
            docker system prune -f

  # Post-deployment tests
  post-deploy-tests:
    name: Post-deployment Tests
    runs-on: ubuntu-latest
    needs: deploy-staging
    steps:
      - name: Health check
        run: |
          sleep 30
          curl -f https://${{ env.STAGING_HOST }}/api/health || exit 1
          curl -f https://${{ env.STAGING_HOST }}/api/v1/health || exit 1

      - name: Notify success
        if: success()
        run: echo "Staging deployment successful!"