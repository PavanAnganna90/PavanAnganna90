# CDN Server for Static Assets
server {
    listen 80;
    server_name localhost;
    root /var/www;
    index index.html;

    # Security
    server_tokens off;
    
    # Static assets with long cache
    location /static/ {
        alias /var/www/static/;
        
        # Apply rate limiting
        limit_req zone=static burst=20 nodelay;
        
        # Cache for 1 year
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header X-Served-By "OpsSight-CDN";
        
        # CORS headers for cross-origin requests
        add_header Access-Control-Allow-Origin "*";
        add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS";
        add_header Access-Control-Allow-Headers "Origin, X-Requested-With, Content-Type, Accept";
        
        # Handle preflight requests
        if ($request_method = OPTIONS) {
            return 204;
        }
        
        # Optimize file serving
        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;
        
        # Security headers
        add_header X-Content-Type-Options "nosniff";
        add_header X-Frame-Options "DENY";
        
        # Try files
        try_files $uri $uri/ =404;
    }

    # Next.js static assets
    location /_next/static/ {
        alias /var/www/_next/static/;
        
        # Apply rate limiting
        limit_req zone=static burst=50 nodelay;
        
        # Cache for 1 year (Next.js handles cache busting with hashes)
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header X-Served-By "OpsSight-CDN";
        
        # CORS headers
        add_header Access-Control-Allow-Origin "*";
        add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS";
        
        # Security headers
        add_header X-Content-Type-Options "nosniff";
        add_header X-Frame-Options "DENY";
        
        # Optimize file serving
        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;
        
        try_files $uri $uri/ =404;
    }

    # Images with medium cache
    location ~* \.(jpg|jpeg|png|gif|ico|svg|webp|avif)$ {
        # Apply rate limiting
        limit_req zone=static burst=30 nodelay;
        
        # Cache for 30 days
        expires 30d;
        add_header Cache-Control "public";
        add_header X-Served-By "OpsSight-CDN";
        
        # CORS headers
        add_header Access-Control-Allow-Origin "*";
        
        # Security headers
        add_header X-Content-Type-Options "nosniff";
        
        # Optimize file serving
        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;
        
        try_files $uri =404;
    }

    # Fonts with long cache
    location ~* \.(woff|woff2|ttf|eot)$ {
        # Apply rate limiting
        limit_req zone=static burst=20 nodelay;
        
        # Cache for 1 year
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header X-Served-By "OpsSight-CDN";
        
        # CORS headers (fonts need CORS)
        add_header Access-Control-Allow-Origin "*";
        add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS";
        
        # Security headers
        add_header X-Content-Type-Options "nosniff";
        
        try_files $uri =404;
    }

    # CSS and JS with medium cache
    location ~* \.(css|js)$ {
        # Apply rate limiting
        limit_req zone=static burst=50 nodelay;
        
        # Cache for 7 days
        expires 7d;
        add_header Cache-Control "public";
        add_header X-Served-By "OpsSight-CDN";
        
        # CORS headers
        add_header Access-Control-Allow-Origin "*";
        
        # Security headers
        add_header X-Content-Type-Options "nosniff";
        
        try_files $uri =404;
    }

    # Health check endpoint
    location /health {
        access_log off;
        return 200 "CDN OK\n";
        add_header Content-Type text/plain;
    }

    # CDN status endpoint
    location /cdn-status {
        access_log off;
        return 200 '{"status":"healthy","service":"opssight-cdn","timestamp":"$time_iso8601"}';
        add_header Content-Type application/json;
    }

    # Block access to hidden files
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    # Default location
    location / {
        return 404;
    }
}